
TARGET_STRING := mario-kart.elf
TARGET := $(TARGET_STRING)

SRC_DIRS :=

# Whether to hide commands or not
VERBOSE ?= 1
ifeq ($(VERBOSE),0)
  V := @
endif

# Whether to colorize build messages
COLOR ?= 1

#==============================================================================#
# Target Executable and Sources                                                #
#==============================================================================#
# BUILD_DIR is the location where all build artifacts are placed
BUILD_DIR := build

# Directories containing source files
SRC_DIRS += src
SRC_DIRS += src/actors
SRC_DIRS += src/audio
SRC_DIRS += src/buffers
SRC_DIRS += src/cpu_vehicles_camera_path
SRC_DIRS += src/data
SRC_DIRS += src/debug
SRC_DIRS += src/ending
SRC_DIRS += src/os
SRC_DIRS += src/racing
SRC_DIRS += build/us/src
SRC_DIRS += build/us/courses
SRC_DIRS += courses
SRC_DIRS += assets
SRC_DIRS += assets/code
SRC_DIRS += assets/code/common_data

C_FILES := $(foreach dir,$(SRC_DIRS),$(wildcard $(dir)/*.c))

# Object files
O_FILES := build/us/src/dcaudio/driver.o build/us/src/buffers/audio_heap.o build/us/src/audio/audio_session_presets.o build/us/src/audio/effects.o build/us/src/audio/mixer.o build/us/src/audio/heap.o build/us/src/audio/playback.o build/us/src/audio/seqplayer.o build/us/src/audio/data.o build/us/src/audio/load.o build/us/src/audio/port_eu.o build/us/src/audio/synthesis.o build/us/src/audio/external.o build/us/src/buffers/all_kinds_of_buffers.o build/us/src/gfx/gfx_cc.o build/us/src/gfx/gfx_dc.o build/us/src/gfx/gfx_gldc.o build/us/src/gfx/gfx_retro_dc.o test.o libmio0.o libtkmk00.o build/us/courses/mario_raceway/course_offsets.o build/us/courses/choco_mountain/course_offsets.o build/us/courses/bowsers_castle/course_offsets.o build/us/courses/banshee_boardwalk/course_offsets.o build/us/courses/yoshi_valley/course_offsets.o build/us/courses/frappe_snowland/course_offsets.o build/us/courses/koopa_troopa_beach/course_offsets.o build/us/courses/royal_raceway/course_offsets.o build/us/courses/luigi_raceway/course_offsets.o build/us/courses/moo_moo_farm/course_offsets.o build/us/courses/toads_turnpike/course_offsets.o build/us/courses/kalimari_desert/course_offsets.o build/us/courses/sherbet_land/course_offsets.o build/us/courses/rainbow_road/course_offsets.o build/us/courses/wario_stadium/course_offsets.o build/us/courses/block_fort/course_offsets.o build/us/courses/skyscraper/course_offsets.o build/us/courses/double_deck/course_offsets.o build/us/courses/dks_jungle_parkway/course_offsets.o build/us/courses/big_donut/course_offsets.o build/us/assets/code/startup_logo/startup_logo.mio0.o build/us/assets/code/ceremony_data/ceremony_data.mio0.o data_segment2.o build/us/data/textures_0a.o build/us/data/other_textures.o build/us/data/texture_tkmk00.o build/us/src/code_800029B0.o build/us/src/profiler.o build/us/src/crash_screen.o build/us/src/animation.o build/us/src/staff_ghosts.o build/us/src/cpu_vehicles_camera_path.o build/us/src/camera.o build/us/src/render_player.o build/us/src/kart_dma.o build/us/src/player_controller.o build/us/src/spawn_players.o build/us/src/code_8003DC40.o build/us/src/gbiMacro.o build/us/src/math_util_2.o build/us/src/render_objects.o build/us/src/code_80057C60.o build/us/src/code_80086E70.o build/us/src/effects.o build/us/src/code_80091440.o build/us/src/menu_items.o build/us/src/checkered_flag.o build/us/src/menus.o build/us/src/save.o build/us/src/ending/credits.o build/us/src/racing/race_logic.o build/us/src/racing/render_courses.o build/us/src/racing/actors.o build/us/src/racing/skybox_and_splitscreen.o build/us/src/racing/memory.o build/us/src/racing/collision.o build/us/src/racing/actors_extended.o build/us/src/racing/math_util.o build/us/courses/courseTable.o build/us/src/buffers/random.o build/us/src/buffers/buffers.o build/us/src/update_objects.o build/us/src/buffers/gfx_output_buffer.o build/us/src/ending/code_80280000.o build/us/src/ending/podium_ceremony_actors.o build/us/src/ending/camera_junk.o build/us/src/ending/code_80281780.o build/us/src/ending/code_80281C40.o build/us/src/ending/ceremony_and_credits.o build/us/src/ending/dl_unk_80284EE0.o build/us/src/data/path_spawn_metadata.o build/us/src/code_80057C60_var.o build/us/src/data/some_data.o build/us/src/data/kart_attributes.o build/us/assets/code/data_800E8700/data_800E8700.o build/us/assets/code/data_800E45C0/data_800E45C0.o build/us/src/code_8006E9C0.o build/us/src/os/gu*.o build/us/src/os/ultra_reimpl.o build/us/src/buffers/trig_tables.o build/us/src/main.o


#build/us/data/sound_data/audiobanks.o 
#build/us/data/sound_data/audiotables.o 
#build/us/data/sound_data/sequences.o 
#build/us/data/sound_data/instrument_sets.o 



# build/us/assets/code/common_data/common_data.o

#build/us/src/gfx/gfx_glx.o build/us/src/gfx/gfx_legacy.o build/us/src/gfx/gfx_pc.o 

# tools
PRINT = printf

ifeq ($(COLOR),1)
NO_COL  := \033[0m
RED     := \033[0;31m
GREEN   := \033[0;32m
BLUE    := \033[0;34m
YELLOW  := \033[0;33m
BLINK   := \033[33;5m
endif

# Common build print status function
define print
  @$(PRINT) "$(GREEN)$(1) $(YELLOW)$(2)$(GREEN) -> $(BLUE)$(3)$(NO_COL)\n"
endef

#==============================================================================#
# Main Targets                                                                 #
#==============================================================================#

all: $(TARGET)

buildtarget:
	mkdir -p $(BUILD_DIR)

$(TARGET): $(O_FILES) | buildtarget
	kos-cc -g3 -o ${BUILD_DIR}/$@ -Xlinker -Map=build/us/mario-kart.elf.map -Wl,--just-symbols=build/us/assets/code/common_data/common_data.elf -Wl,--just-symbols=build/us/courses/mario_raceway/course_data.elf -Wl,--just-symbols=build/us/courses/choco_mountain/course_data.elf -Wl,--just-symbols=build/us/courses/bowsers_castle/course_data.elf -Wl,--just-symbols=build/us/courses/banshee_boardwalk/course_data.elf -Wl,--just-symbols=build/us/courses/yoshi_valley/course_data.elf -Wl,--just-symbols=build/us/courses/frappe_snowland/course_data.elf -Wl,--just-symbols=build/us/courses/koopa_troopa_beach/course_data.elf -Wl,--just-symbols=build/us/courses/royal_raceway/course_data.elf -Wl,--just-symbols=build/us/courses/luigi_raceway/course_data.elf -Wl,--just-symbols=build/us/courses/moo_moo_farm/course_data.elf -Wl,--just-symbols=build/us/courses/toads_turnpike/course_data.elf -Wl,--just-symbols=build/us/courses/kalimari_desert/course_data.elf -Wl,--just-symbols=build/us/courses/sherbet_land/course_data.elf -Wl,--just-symbols=build/us/courses/rainbow_road/course_data.elf -Wl,--just-symbols=build/us/courses/wario_stadium/course_data.elf -Wl,--just-symbols=build/us/courses/block_fort/course_data.elf -Wl,--just-symbols=build/us/courses/skyscraper/course_data.elf -Wl,--just-symbols=build/us/courses/double_deck/course_data.elf -Wl,--just-symbols=build/us/courses/dks_jungle_parkway/course_data.elf -Wl,--just-symbols=build/us/courses/big_donut/course_data.elf -Wl,--just-symbols=build/us/assets/code/startup_logo/startup_logo.elf -Wl,--just-symbols=build/us/assets/code/ceremony_data/ceremony_data.elf -Wl,--just-symbols=build/us/courses/yoshi_valley/course_data.elf -Wl,--just-symbols=build/us/courses/skyscraper/course_data.elf -Wl,--just-symbols=build/us/courses/choco_mountain/course_data.elf -Wl,--just-symbols=build/us/courses/block_fort/course_data.elf -Wl,--just-symbols=build/us/courses/bowsers_castle/course_data.elf -Wl,--just-symbols=build/us/courses/toads_turnpike/course_data.elf -Wl,--just-symbols=build/us/courses/kalimari_desert/course_data.elf -Wl,--just-symbols=build/us/courses/luigi_raceway/course_data.elf -Wl,--just-symbols=build/us/courses/frappe_snowland/course_data.elf -Wl,--just-symbols=build/us/courses/rainbow_road/course_data.elf -Wl,--just-symbols=build/us/courses/double_deck/course_data.elf -Wl,--just-symbols=build/us/courses/mario_raceway/course_data.elf -Wl,--just-symbols=build/us/courses/big_donut/course_data.elf -Wl,--just-symbols=build/us/courses/wario_stadium/course_data.elf -Wl,--just-symbols=build/us/courses/koopa_troopa_beach/course_data.elf -Wl,--just-symbols=build/us/courses/sherbet_land/course_data.elf -Wl,--just-symbols=build/us/courses/dks_jungle_parkway/course_data.elf -Wl,--just-symbols=build/us/courses/banshee_boardwalk/course_data.elf -Wl,--just-symbols=build/us/courses/moo_moo_farm/course_data.elf -Wl,--just-symbols=build/us/courses/royal_raceway/course_data.elf $(O_FILES) -Wl,-lGL




# ./src/gfx/gldc/libGLdc.a

#
# -Wl,--no-gc-sections 

#-Wl,-T undefined_syms.txt 

clean:
	$(RM) mariokart64.cdi $(O_FILES) $(BUILD_DIR)/$(TARGET)

cdi:
	@test -s ${BUILD_DIR}/${TARGET_STRING} || { echo "Please run make or copy release ${TARGET_STRING} to ${BUILD_DIR} dir before running make cdi . Exiting"; exit 1; }
	$(RM) mariokart64.cdi
	mkdcdisc -d dc_data -e $(BUILD_DIR)/$(TARGET) -o mariokart64.cdi -n "Mario Kart 64" -N -v 3

dcload: $(TARGET)
	sudo ./dcload-ip/host-src/tool/dc-tool-ip -g -x $(BUILD_DIR)/$(TARGET) -c ./

ALL_DIRS := $(BUILD_DIR) $(addprefix $(BUILD_DIR)/,$(SRC_DIRS))

print-% : ; $(info $* is a $(flavor $*) variable set to [$($*)]) @true

include ${KOS_BASE}/Makefile.rules
